TAS {
  space := whitespace

  Cmd (a valid top-level expression)
                  = NonemptyListOf<Expr, Term> -- Exprs
  Term            = Bar | lineTerminator
  Bar             = "|" lineTerminator?

  Expr (a valid expression) 
                  = (Let | CmdExpr | CtxExpr |  Val) (":" TypeExpr)?
  TypeExpr        = letter alnum*                  
  Let             = "let" CmdId "=" Val
  FunExpr         = "?" Subscript*
  CtxExpr         = "$" Subscript*
  ValueExpr       = CmdId Subscript*
  Subscript       = ArraySubscript | PropSubScript
  ArraySubscript  = "[" Int "]"
  PropSubScript   = "." Key
  ArgExpr         = FunExpr | CmdExpr
  CmdId           = letter alnum*
  CmdExpr         = CmdId (whitespace* (FunExpr))*
  Val             = whitespace* (
                    Int
                  | ObjLiteral
                  | ArrayLiteral
                  ) whitespace*
  ArrayLiteral    = "[" (Val ("," Val)* ","?)? "]"
  Int             = "+" decimalDigit* -- positive
                  | "-" decimalDigit* -- negative
                  |     decimalDigit+ -- noSign
  ObjLiteral      = "{" (ObjPair ("," ObjPair)* ","?)? "}"
  ObjPair         = (Key ":" Val)
  Key             = KeyPath
  KeyPath         = whitespace* (letter alnum*) whitespace*


  unicodeSpaceSeparator = "\u2000".."\u200B" | "\u3000"
  zeroToThree = "0".."3"
  fourToSeven = "4".."7"
  whitespace = "\t"
             | "\x0B"    -- verticalTab
             | "\x0C"    -- formFeed
             | " "
             | "\u00A0"  -- noBreakSpace
             | "\uFEFF"  -- byteOrderMark
             | unicodeSpaceSeparator
  doubleStringCharacter = ~("\"" | "\\" | lineTerminator) sourceCharacter -- nonEscaped
                      | "\\" escapeSequence                             -- escaped
                      | lineContinuation                                -- lineContinuation
  singleStringCharacter = ~("'" | "\\" | lineTerminator) sourceCharacter -- nonEscaped
                      | "\\" escapeSequence                            -- escaped
                      | lineContinuation                               -- lineContinuation
  sourceCharacter = any
  lineContinuation = "\\" lineTerminatorSequence
    escapeSequence = unicodeEscapeSequence
                | hexEscapeSequence
                | octalEscapeSequence
                | characterEscapeSequence  // Must come last.
  characterEscapeSequence = singleEscapeCharacter
                          | nonEscapeCharacter
  singleEscapeCharacter = "'" | "\"" | "\\" | "b" | "f" | "n" | "r" | "t" | "v"
  nonEscapeCharacter = ~(escapeCharacter | lineTerminator) sourceCharacter
  escapeCharacter = singleEscapeCharacter | decimalDigit | "x" | "u"
  octalEscapeSequence = zeroToThree octalDigit octalDigit    -- whole
                      | fourToSeven octalDigit               -- eightTimesfourToSeven
                      | zeroToThree octalDigit ~decimalDigit -- eightTimesZeroToThree
                      | octalDigit ~decimalDigit             -- octal
  hexEscapeSequence = "x" hexDigit hexDigit
  unicodeEscapeSequence = "u" hexDigit hexDigit hexDigit hexDigit

  octalDigit = "0".."7"
  decimalDigit = "0".."9"
  nonZeroDigit = "1".."9"
  lineTerminatorSequence = "\n" | "\r" ~"\n" | "\u2028" | "\u2029" | "\r\n"
  lineTerminator = "\n" | "\r" | "\u2028" | "\u2029"
}